name: Auto Label with Claude

on:
  pull_request:
    types: [opened, reopened, edited]
  issues:
    types: [opened, reopened, edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Auto Label with Claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: false
          use_sticky_comment: false
          prompt: |
            REPO: ${{ github.repository }}
            ${{ github.event.pull_request && format('PR NUMBER: {0}', github.event.pull_request.number) || format('ISSUE NUMBER: {0}', github.event.issue.number) }}

            **Task: Minimal Auto-Labeling (1-3 labels)**

            Apply the MINIMUM labels needed. Less is more. When in doubt, skip the label.

            **Target: 1-3 labels. Rarely exceed 3.**

            **Labels:**

            *Type (pick exactly 1):*
            - `bug` - Something is broken
            - `feature` - New functionality
            - `enhancement` - Improving existing feature
            - `documentation` - Docs only
            - `dependencies` - Dependency updates
            - `refactor` - Code restructure, no behavior change
            - `testing` - Test files only
            - `ci/cd` - Workflow/pipeline changes

            *Area (pick 0-2, only if clearly relevant):*
            - `frontend` - UI components
            - `backend` - Server/API logic
            - `supabase` - Database changes
            - `authentication` - Auth flow
            - `android` - Android-only code
            - `ios` - iOS-only code
            - `web` - Web-only code
            - `security` - Security fix
            - `accessibility` - a11y fix
            - `performance` - Optimization

            **Decision Process:**
            1. Read: `gh ${{ github.event.pull_request && 'pr' || 'issue' }} view ${{ github.event.pull_request && github.event.pull_request.number || github.event.issue.number }}`
            ${{ github.event.pull_request && '2. Check diff: `gh pr diff`' || '' }}
            ${{ github.event.pull_request && '3' || '2' }}. Ask: "What is the ONE main thing this does?"
            ${{ github.event.pull_request && '4' || '3' }}. Pick 1 type label (required)
            ${{ github.event.pull_request && '5' || '4' }}. Pick 0-2 area labels if clearly relevant
            ${{ github.event.pull_request && '6' || '5' }}. Apply with: `gh ${{ github.event.pull_request && format('pr edit {0}', github.event.pull_request.number) || format('issue edit {0}', github.event.issue.number) }} --add-label "label1,label2"`

            **Examples (1-3 labels):**
            - Login crashes → `bug`, `authentication`
            - Add dark mode → `feature`, `frontend`
            - Update README → `documentation`
            - Bump dependencies → `dependencies`
            - Fix iOS build → `bug`, `ios`
            - Refactor auth context → `refactor`, `authentication`
            - Add tests → `testing`
            - Fix XSS vulnerability → `bug`, `security`
            - New auth settings page → `feature`, `frontend`, `authentication`
            - CI workflow update → `ci/cd`

            **Keep it minimal. 3 labels is the practical max for most changes.**

            Execute now.

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr edit:*),Bash(gh issue view:*),Bash(gh issue edit:*)"'
