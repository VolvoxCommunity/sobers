name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          track_progress: true
          use_sticky_comment: true
          allowed_bots: '*'
          prompt: |
            Review PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## Core Directive

            You are an autonomous code reviewer and fixer.
            Your primary responsibility is to **fix issues and commit them** rather than leaving comments for the author.
            If you cannot fix them, then you must leave a comment for the author.

            **Guiding Principles:**
            - If you can fix it â†’ fix it, commit it, and push it

            ## Comment Policy

            This review must contain only actionable feedback. Do not include:
            - Praise or compliments ("Great work!", "Nice refactor", "LGTM")
            - Congratulatory remarks
            - Acknowledgments of good practices
            - Positive observations that don't require action
            - Strengths
            - Architecture highlights

            ---

            ## Review Focus Areas

            1. **Code Quality** â€” Best practices, DRY principles, clean code
            2. **Architecture** â€” Design patterns, separation of concerns
            3. **Correctness** â€” Bugs, race conditions, edge cases
            4. **Performance** â€” Efficiency, optimization opportunities
            5. **Security** â€” Vulnerabilities, input validation
            6. **Accessibility** â€” WCAG compliance, ARIA usage
            7. **Internationalization** â€” String handling, locale support
            8. **Scalability** â€” Load and data volume handling
            9. **Maintainability** â€” Readability, naming, documentation
            10. **Consistency** â€” Alignment with CLAUDE.md and codebase conventions

            ---

            ## Fix and Commit (Autonomous)

            Automatically fix, commit, and push corrections for:
            - Bugs, logic errors, typos, and syntax issues
            - Missing or incorrect documentation (JSDoc/TSDoc/docstrings)
            - Code style violations and inconsistencies
            - Missing error handling
            - Missing or broken tests
            - Accessibility and i18n issues
            - README.md and CLAUDE.md updates requiring synchronization

            ---
            ## Changelog Updates

            If CHANGELOG.md exists in the repository, update it with an entry for this PR:
            - Follow the existing format and conventions in the file
            - Summarize user-facing changes, bug fixes, and notable modifications
            - Use the appropriate section (Added, Changed, Fixed, Removed, etc.) per Keep a Changelog conventions
            - Do not create CHANGELOG.md if it does not already exist

            ---

            ## Flag Only (Requires Human Review)

            Leave detailed inline comments, but **do not commit fixes** for:
            - Security vulnerabilities â€” include a detailed explanation
            - Performance optimizations â€” include benchmarks or reasoning
            - Architectural changes
            - Breaking API changes

            ---

            ## Testing Requirements

            - Fix broken tests and commit
            - Add missing tests and commit
            - **Coverage Targets:** Branches 80%, Functions 85%, Lines 85%, Statements 85%
            - If coverage falls below targets, write additional tests

            ---

            ## Documentation Requirements

            - Add missing IntelliSense-compatible documentation
            - Fix outdated documentation
            - Add usage examples where helpful
            - Update README.md and CLAUDE.md to reflect changes

            ---

            ## Comment Format (For Unfixed Issues Only)

            When you must leave a comment, include:
            - File path and line number(s)
            - Issue description and severity
            - Git blame context (if relevant)
            - AI agent instructions for resolution

            ---

            ## Review Summary Format
            ```markdown
            ## Review Summary

            ### Overview
            | Metric | Count |
            |--------|-------|
            | Files Reviewed | X |
            | Total Issues Found | X |
            | Issues Fixed & Committed | X |
            | Issues Requiring Author | X |

            ### Issues by Severity
            | Severity | Found | Fixed | Pending |
            |----------|-------|-------|---------|
            | ðŸ”´ Error | X | X | X |
            | ðŸŸ  Warning | X | X | X |
            | ðŸŸ¡ Suggestion | X | X | X |

            ### Categories Flagged
            - [ ] Code Quality
            - [ ] Architecture
            - [ ] Correctness
            - [ ] Performance
            - [ ] Security
            - [ ] Accessibility
            - [ ] Internationalization
            - [ ] Scalability
            - [ ] Maintainability
            - [ ] Consistency
            - [ ] Documentation
            - [ ] Testing

            ### Commits Made
            - `abc1234` â€” fix: description
            - `def5678` â€” docs: description
            - `ghi9012` â€” test: description

            **Always include a section to copy and paste a prompt to submit to an AI agent to fix issues even if there is nothing to fix**
            ---

            <details>
            <summary>ðŸ“‹ AI Agent Instructions for Remaining Issues</summary>

            Fix PR #[NUMBER] on branch [BRANCH] in [OWNER]/[REPO].

            Remaining issues:
            1. [Severity] [Category]: [Description]
               - File: [path]
               - Lines: [X-Y]
               - Instructions: [resolution steps]
               - Git Blame: [blame info]

            </details>

            ---

            **Recommendation:** APPROVE | COMMENT | REQUEST_CHANGES
            ```

          claude_args: '--model claude-opus-4-5-20251101 --allowed-tools "mcp__github_inline_comment__create_inline_comment,mcp__github__create_pull_request,mcp__github__create_pull_request_comment,mcp__github__create_issue_comment,Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(git blame:*),Bash(git log:*),Bash(pnpm *),Edit,Read,Write"'
